# Survey Snippets

Overview:

We use qualtrics and hack together both the [Javascript Questions API](https://api.qualtrics.com/82bd4d5c331f1-qualtrics-java-script-question-api-class) and the [Response API](https://api.qualtrics.com/354c312da7cc7-survey-responses).

When respondents consent to share data, they do so with a Qualtrics multiple choice question type, rather than a file upload question type. This allows us to (a) parse/strip/etc the shared data before uploading it and (b) continue the survey logic based on their multiple choice answer. 

The result is 1-2 responses per respondent.

1. Survey responses for questions the respondant filled out in the survey. It excludes the file upload. This response row contains a ResponseId=ResponseId to be treated as the respondent's ResponseId.

2. Only included if respondent consented to sharing their Amazon data. These responses only contain file uploads. The ResponseId generated by qualtrics is different but the file name corresponds to the ResponseId for the respondent who shared the file.

About the files:
The files are the Amazon purchase histories data shared by the respondents. 
They only contain the data that the respondent consented to share (if they did). No other data is ever sent to the server.

We use qualtrics in the following way so that we can:

- use qualtrics question logic features!
- quickly prototype and iterate
- have a place to upload data (for both survey questions and Amazon data)

Here is how we do this (can skip why):

## Set up 

### Invisible File Upload

We upload data files to an invisible file upload question.

#### Steps:
- Create as the first question: A file upload question type.
- Make the question always hidden. Can do this via display logic: Display question with true/false --> set to false. (Preview survey to make sure hidden)
- Get the __FQID__: Capture the Question ID for the file upload question. Call this the __FQID__: It is of form QID{int}. It is NOT the same as the Q{int} name shown in the survey builder. A few ways to get it. Can get the FQID value using the [piped text feature](https://www.qualtrics.com/support/survey-platform/survey-module/editing-questions/piped-text/piped-text-overview/#PipingFromAPreviousQuestion):
    - click to edit the question
    - click Piped Text > Survey Question
    - edit this survey question. Select anything (File Name)
    - See in the question: ${q://{FQID}/UploadedFileName}



Why do it this way?
- we want a file upload question type / endpoint to save files to
- we don't want respondents to directly upload files using the qualtrics file upload question type because:
    - we need to parse the files in the browser to strip data and present the data to the user
    - we want the respondent to answer whether they consent to sharing their data and upload the file based on the consent (i.e. use the multiple choice question type)
    - qualtrics immediately uploads files to the server upon the respondent putting them in a file field
    - not only does this go against what we say about not saving any user data without full consent first, qualtrics also then removes the file from the file field so we don't have easy access to it: problem
    - so we create our own file input field in the multiple choice question type and then use this invisible question as an API endpoint to send files to.

### Set embedded data

We set embedded data (some specific to this survey) to get and use in the questions.

#### Steps:
- Go into Survey Flow.
- Add new element > Embedded data
- Move the elemnt to the top of the survey flow
- Use Add New Field to set the embedded data elements:
- SurveyID: from Survey Metadata
- ResponseID: from Survey Metadata (not RID)
- FQID: Custom value from above
- API_TOKEN: Custom value



## Data share question versions

Respondents are shown different Qualtrics questions that prompt them to share their data based on their treatment arm/experiment parameters.

We use the multiple choice question type.

### Question choice codes

Make sure the question choice values are recoded as follows.

- 1 = Yes / consent to share
- 0 = No / decline to share

Steps:
- click on the question
- click Button behavior > x -> Recode values

Why?
- we only upload the data if Yes -- need to get value via JS upon question submission.

### Question HTML and JS

The questions we show users where they can upload their Amazon data are created via editing the question using the HTML editor. 

Each question HTML has the form:

```
[CSS]
[HTML]
<!-- JS libraries  -->
<script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

<!-- Our JS  -->
<!-- Only include in test snippets  -->
<script src="our-scripts.js"></script>
```

For each Qualtrics data share question version:
- put the HTML for the question version into the HTML editor
- EXCLUDING anything below `<!-- Only include in test snippets  -->`

- Dump the contents of our JS script into the Qualtrics question JavaScript editor:

```
Qualtrics.SurveyEngine.addOnload(function() {

    // all of our JavaScript

});
```

Why:
- JS: It must be done this way to make the advertised Qualtrics.SurveyEngine APIs work properly. Why not put our JS into external scripts like the libraries? 
Many hours went into trying to make this work otherwise via external scripts. The API interface does not seem to properly work outside of the JS editing interface Qualtrics provides.


### Data upload question versions

Different question versions (with different language) are in separate `Q-upload-[name].html` files for ease of use, iteration, testing.

For updating the Qualtrics survey, can directly copy+paste from the versioned HTML into the qualtrics question (using the HTML editor) for that version.

Can also view as standalone files.

e.g.
https://aberke.github.io/amazon-study/survey-snippets/upload-questions/Q-upload-control.html


Can toggle between different experimental ways for data to be shown via URL parameters.

- `?data=A` : limited table columns
- `?data=B` : more table columns
- `?showdata=false` : name the table columns without showing the table




## Retrieving the data

Go into Qualtrics survey

Data and Analysis > Export & Import.


## Debugging Notes

Previewing vs publishing changes.
- hacking in Preview mode is tough because content is loaded into an iframe (not done in published mode).
- can still access Preview mode elements via something like...
```
idoc = document.getElementById('preview-view').contentWindow.document;
fileInput = idoc.getElementById('file-input');
```
- Simpler dev process for handling code debugging: Using a scratch survey and testing changes in that survey and publishing them.

Qualtrics Questions API Interface does not support many tokens:
- `*` for multiplication
- backticks for strings
- `async`
